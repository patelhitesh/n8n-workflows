<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number Kingdom ‚Äî The Royal Vault</title>
  <meta name="description" content="Crack the Royal Vault by finding the Four Magic Numbers that satisfy the King's clues." />
  <meta name="color-scheme" content="light dark">

  <style>
    :root{
      --bg: linear-gradient(135deg,#0f172a 0%,#1e293b 35%,#0b1324 100%);
      --card-bg: hsl(222 36% 12% / .55);
      --card-stroke: hsl(220 40% 30% / .2);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --accent-2: #22d3ee;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg: radial-gradient(1200px 800px at 10% 10%, #f0f7ff, #eef2ff 40%, #e0e7ff 60%, #e2e8f0 100%);
        --card-bg: rgba(255,255,255,.65);
        --card-stroke: rgba(0,0,0,.06);
        --text: #0f172a;
        --muted: #475569;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg) fixed;
      color: var(--text);
      display:grid;
      place-items:center;
    }

    .container{
      width:min(1100px, 92vw);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 24px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .container{grid-template-columns: 1fr; gap:16px}
    }

    .card{
      background: var(--card-bg);
      border: 1px solid var(--card-stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 22px;border-bottom:1px solid var(--card-stroke)
    }
    .title{
      font-weight:800;letter-spacing:.4px;font-size: clamp(20px, 2.3vw, 28px);
      display:flex;gap:10px;align-items:center
    }
    .badge{
      font-size:12px;font-weight:700;
      padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#0b1020
    }
    .content{padding:22px}
    .grid{
      display:grid;gap:16px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width:680px){.grid{grid-template-columns: repeat(2, 1fr)}}
    .field{
      display:flex;flex-direction:column;gap:8px
    }
    .field label{font-size:12px;letter-spacing:.35px;text-transform:uppercase;color:var(--muted)}
    .input{
      border:1px solid var(--card-stroke);
      background: rgba(255,255,255,.06);
      color:inherit;
      border-radius:12px;
      padding:14px 12px;font-size:18px;font-weight:700;
      outline:none;transition: .2s border-color, .2s transform;
    }
    .input:focus{border-color:var(--accent); transform: translateY(-1px)}
    .input[aria-invalid="true"]{border-color:var(--danger)}

    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    button{
      --bgc: rgba(255,255,255,.06);
      border:1px solid var(--card-stroke);
      background: var(--bgc);
      color: inherit;
      padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:700;
      transition: .2s transform, .2s border-color, .2s filter;
      display:inline-flex;align-items:center;gap:10px;
    }
    button:hover{transform: translateY(-1px); filter:brightness(1.05)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b1020; border-color:transparent}
    .btn-success{background:linear-gradient(90deg,#8bfa60,#22c55e); color:#07220b; border-color:transparent}
    .btn-danger{background:linear-gradient(90deg,#fecaca,#f87171); color:#3b0b0b; border-color:transparent}
    .btn-ghost{--bgc: rgba(255,255,255,.04)}
    .note{font-size:14px;color:var(--muted);line-height:1.45}

    .callout{
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border:1px dashed var(--card-stroke); border-radius:12px; padding:14px;
    }
    .status{
      margin-top:14px; padding:12px;border-radius:12px;border:1px solid var(--card-stroke);
      background: rgba(255,255,255,.05);
    }
    .status.success{border-color: rgba(34,197,94,.5)}
    .status.error{border-color: rgba(239,68,68,.5)}
    .status.warn{border-color: rgba(245,158,11,.5)}

    /* Hourglass */
    .hourglass{
      width:28px;height:28px;position:relative;display:inline-block;transform: rotate(0deg);
      margin-right:8px;
    }
    .hourglass:before,.hourglass:after{
      content:""; position:absolute; inset:0; border:3px solid var(--muted);
      border-radius:6px; clip-path: polygon(0 0, 100% 0, 65% 50%, 100% 100%, 0 100%, 35% 50%);
    }
    .sand{
      position:absolute; left:50%; top:5px; width:4px; height:18px; transform:translateX(-50%);
      background: linear-gradient(var(--warning), transparent 60%);
      animation: flow var(--duration,180s) linear infinite;
      border-radius: 2px;
    }
    @keyframes flow{
      0%{height:18px; top:5px; opacity:1}
      49%{height:0px; top:23px; opacity:.7}
      51%{height:0px; top:5px; opacity:.7}
      100%{height:18px; top:5px; opacity:1}
    }

    /* Reasoning accordion */
    details{
      background: rgba(255,255,255,.05); border:1px solid var(--card-stroke); border-radius:12px;
      padding:12px 14px;
    }
    details[open]{background: rgba(255,255,255,.07)}
    summary{cursor:pointer;font-weight:800; list-style:none}
    summary::-webkit-details-marker{display:none}
    .reasoning{line-height:1.6;margin-top:6px}
    code.kpill{
      background: rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.35);
      padding:2px 8px;border-radius:999px;font-weight:800
    }

    /* Confetti canvas */
    #fx-confetti{position:fixed; inset:0; pointer-events:none; z-index:5}

    /* Footer */
    .footer{
      display:flex;justify-content:space-between;align-items:center; gap:8px;
      padding:12px 18px; border-top:1px solid var(--card-stroke); color:var(--muted); font-size:12px
    }
    .kbd{
      border:1px solid var(--card-stroke); border-bottom-width:3px; border-radius:8px; padding:2px 6px; font-weight:800; color:inherit
    }
  </style>
</head>
<body>

<canvas id="fx-confetti" aria-hidden="true"></canvas>

<main class="container" role="main">
  <!-- Left: Game -->
  <section class="card" aria-labelledby="game-title">
    <header class="header">
      <div class="title" id="game-title">
        <span class="hourglass" aria-hidden="true"><span class="sand"></span></span>
        Number Kingdom ‚Äî The Royal Vault
        <span class="badge">Puzzle</span>
      </div>
      <div class="note" id="timer" aria-live="polite">03:00 left</div>
    </header>

    <div class="content">
      <p class="note" id="intro">
        Welcome to the Number Kingdom! The Royal Vault opens only if you enter the <strong>Four Magic Numbers</strong> in the correct order before the sand runs out.
      </p>

      <div class="callout" role="region" aria-labelledby="clues-title">
        <strong id="clues-title">The King's clues:</strong>
        <ul>
          <li>The sum of the four numbers is <strong>100</strong>.</li>
          <li>Each number is a whole number <strong>greater than 0</strong>.</li>
          <li>The first number is <strong>twice</strong> the second.</li>
          <li>The third number is the <strong>average</strong> of the first two.</li>
          <li>The last number is <strong>|second ‚àí third|</strong> (absolute value).</li>
        </ul>
      </div>

      <div class="grid" aria-label="Enter the four numbers">
        <div class="field">
          <label for="n1">First number</label>
          <input id="n1" class="input" inputmode="numeric" autocomplete="off" maxlength="3" />
        </div>
        <div class="field">
          <label for="n2">Second number</label>
          <input id="n2" class="input" inputmode="numeric" autocomplete="off" maxlength="3" />
        </div>
        <div class="field">
          <label for="n3">Third number</label>
          <input id="n3" class="input" inputmode="numeric" autocomplete="off" maxlength="3" />
        </div>
        <div class="field">
          <label for="n4">Fourth number</label>
          <input id="n4" class="input" inputmode="numeric" autocomplete="off" maxlength="3" />
        </div>
      </div>

      <div class="controls" aria-label="Actions">
        <button class="btn-primary" id="checkBtn" title="Check your attempt (Enter)">
          ‚úÖ Check Answer
        </button>
        <button class="btn-success" id="explainBtn" title="Generate a step-by-step proof for the King">
          üß† Explain to the King
        </button>
        <button class="btn-ghost" id="hintBtn" title="Get a hint">
          üí° Hint
        </button>
        <button class="btn-ghost" id="fillBtn" title="Auto-fill the correct numbers">
          üß© Auto-fill
        </button>
        <button class="btn-danger" id="resetBtn" title="Clear and restart the timer">
          ‚ôªÔ∏è Reset
        </button>
      </div>

      <div class="status" id="status" role="status" aria-live="polite" style="display:none"></div>

      <details id="reason" style="margin-top:16px">
        <summary>See the algebra (spoiler-free until opened)</summary>
        <div class="reasoning" id="reasoningText"></div>
      </details>

      <p class="note" style="margin-top:12px">Pro tip: Press <span class="kbd">Enter</span> to check, <span class="kbd">H</span> for hint, and <span class="kbd">R</span> to reset.</p>
    </div>

    <footer class="footer">
      <span>Accessibility: labeled inputs, keyboard shortcuts, reduced-motion friendly.</span>
      <span>¬© Number Kingdom</span>
    </footer>
  </section>

  <!-- Right: Sidebar -->
  <aside class="card" aria-labelledby="side-title">
    <header class="header">
      <div class="title" id="side-title">Game Log & Hints</div>
    </header>
    <div class="content">
      <div id="log" class="note" style="min-height:120px; white-space:pre-wrap;"></div>
      <hr style="border:0;border-top:1px solid var(--card-stroke); margin:16px 0">
      <div class="note">
        <strong>About this build</strong><br/>
        ‚Ä¢ Client-side only, no dependencies<br/>
        ‚Ä¢ Robust validation & clear error states<br/>
        ‚Ä¢ Works offline, responsive, a11y-friendly<br/>
      </div>
    </div>
  </aside>
</main>

<script>
  // --- Utilities ------------------------------------------------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const inputs = ['#n1','#n2','#n3','#n4'].map($);

  const pad = n => String(n).padStart(2,'0');
  const clampInt = (v) => {
    const m = String(v).match(/^\s*(-?\d+)\s*$/);
    return m ? parseInt(m[1],10) : NaN;
  };

  // --- Timer ---------------------------------------------------------------
  const DURATION = 180; // seconds
  let timeLeft = DURATION;
  let tHandle = null;

  function startTimer(){
    clearInterval(tHandle);
    timeLeft = DURATION;
    updateTimerLabel();
    tHandle = setInterval(()=>{
      timeLeft--;
      updateTimerLabel();
      if(timeLeft<=0){ clearInterval(tHandle); onTimeUp(); }
    }, 1000);
    document.documentElement.style.setProperty('--duration', DURATION+'s');
  }
  function updateTimerLabel(){
    const mm = Math.floor(timeLeft/60), ss = timeLeft%60;
    const el = $('#timer');
    el.textContent = `${pad(mm)}:${pad(ss)} left`;
    if(timeLeft<=20) el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--warning');
    if(timeLeft<=10) el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--danger');
  }
  function onTimeUp(){
    toast("‚è≥ The Royal Hourglass is empty. Try again!", 'error');
    wiggle(inputs);
  }

  // --- Confetti (tiny, dependency-free) ------------------------------------
  const confettiCanvas = $('#fx-confetti');
  const ctx = confettiCanvas.getContext('2d');
  let confettiActive = false, confettiPieces = [];
  function resizeCanvas(){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  function launchConfetti(){
    confettiActive = true;
    confettiPieces = [...Array(150)].map(()=>({
      x: Math.random()*confettiCanvas.width,
      y: -10 - Math.random()*200,
      r: 3 + Math.random()*4,
      vx: -1 + Math.random()*2,
      vy: 1 + Math.random()*2,
      a: Math.random()*Math.PI*2,
      spin: -0.2 + Math.random()*0.4,
      s: 0.7 + Math.random()*1.3
    }));
    requestAnimationFrame(drawConfetti);
    setTimeout(()=>{ confettiActive = false }, 2200);
  }
  function drawConfetti(){
    if(!confettiActive) return;
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    confettiPieces.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.a += p.spin;
      p.vy += 0.01;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = ['#60a5fa','#22d3ee','#34d399','#f59e0b','#f472b6'][Math.floor(Math.random()*5)];
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    });
    confettiPieces = confettiPieces.filter(p=> p.y < confettiCanvas.height+20);
    requestAnimationFrame(drawConfetti);
  }

  // --- Game Logic ----------------------------------------------------------
  function getValues(){
    return inputs.map(i=>{
      const v = clampInt(i.value);
      return Number.isFinite(v) ? v : NaN;
    });
  }
  function setValues([a,b,c,d]){
    $('#n1').value=a; $('#n2').value=b; $('#n3').value=c; $('#n4').value=d;
  }
  function clearInvalid(){
    inputs.forEach(i=> i.setAttribute('aria-invalid','false'));
  }
  function markInvalid(indices){
    indices.forEach(idx => inputs[idx].setAttribute('aria-invalid','true'));
    wiggle(indices.map(idx=>inputs[idx]));
  }
  function wiggle(els){
    els.forEach(el=>{
      el.style.transition = 'transform .06s';
      el.style.transform = 'translateX(-3px)';
      setTimeout(()=>{ el.style.transform='translateX(3px)' }, 60);
      setTimeout(()=>{ el.style.transform='translateX(0)' }, 120);
      setTimeout(()=>{ el.style.transition = '' }, 200);
    });
  }

  function validate([a,b,c,d]){
    const errs = [];
    const invalidIdx = [];
    const allNums = [a,b,c,d].every(Number.isFinite);

    if(!allNums){ errs.push("Please enter whole numbers only."); inputs.forEach((_,i)=>invalidIdx.push(i)) }

    if(allNums){
      if([a,b,c,d].some(n => n<=0 || !Number.isInteger(n))){
        errs.push("All four must be whole numbers greater than 0.");
        [a,b,c,d].forEach((n,i)=>{ if(!(Number.isInteger(n) && n>0)) invalidIdx.push(i); });
      }
      if(a !== 2*b){ errs.push("The first must be exactly twice the second."); invalidIdx.push(0,1); }
      if(c !== (a+b)/2){ errs.push("The third must be the average of the first two."); invalidIdx.push(2); }
      if(d !== Math.abs(b-c)){ errs.push("The fourth must be |second - third|."); invalidIdx.push(3); }
      if(a+b+c+d !== 100){ errs.push("The sum of all four must be 100."); invalidIdx.push(0,1,2,3); }
    }
    return { ok: errs.length===0, errs: [...new Set(errs)], invalidIdx: [...new Set(invalidIdx)] };
  }

  function toast(msg, kind='warn'){
    const box = $('#status');
    box.style.display='block';
    box.className = `status ${kind==='success'?'success':kind==='error'?'error':'warn'}`;
    box.textContent = msg;
    log(`[${new Date().toLocaleTimeString()}] ${msg}`);
  }

  function log(line){
    const el = $('#log');
    el.textContent = (el.textContent ? el.textContent + "\n" : "") + line;
    el.scrollTop = el.scrollHeight;
  }

  function explain(a,b,c,d){
    // Derive k from structure: let b=2k so that c=3k is integer, etc.
    const k = d; // since d = |b - c| = |2k - 3k| = k
    const steps = [
      "Let the four numbers be a, b, c, d.",
      "From the clues: a = 2b; c = (a + b)/2; d = |b ‚àí c|.",
      "Substitute a = 2b into c: c = (2b + b)/2 = 3b/2.",
      "For c to be a whole number, b must be even. Let b = 2k (k is a positive integer).",
      "Then a = 4k, c = 3k, and d = |2k ‚àí 3k| = k.",
      "Their sum is a + b + c + d = 4k + 2k + 3k + k = 10k.",
      "Since the sum must be 100, 10k = 100 ‚áí k = 10.",
      "Therefore b = 2k = 20, a = 4k = 40, c = 3k = 30, d = k = 10.",
      `So the Four Magic Numbers are: ${a}, ${b}, ${c}, ${d}.`
    ];
    $('#reasoningText').innerHTML = steps
      .map(s => `<div>${s.replace(/k(?![a-zA-Z])/g,'<code class="kpill">k</code>')}</div>`)
      .join("");
    $('#reason').open = true;
  }

  // --- Hint system ---------------------------------------------------------
  const hints = [
    "Start with the relation a = 2b. Then the average of a and b is (a + b)/2.",
    "If c is the average of a and b and must be whole, b must be even.",
    "Try writing b as 2k so that a=4k, c=3k, d=k, and the total is 10k.",
    "10k must equal 100. What's k?"
  ];
  let hintIndex = 0;

  // --- Hotkeys -------------------------------------------------------------
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); $('#checkBtn').click(); }
    if(e.key.toLowerCase() === 'h'){ e.preventDefault(); $('#hintBtn').click(); }
    if(e.key.toLowerCase() === 'r'){ e.preventDefault(); $('#resetBtn').click(); }
  });

  // --- Wire up buttons -----------------------------------------------------
  $('#checkBtn').addEventListener('click', ()=>{
    clearInvalid();
    const vals = getValues();
    const {ok, errs, invalidIdx} = validate(vals);
    if(ok){
      toast("üéâ Correct! The Vault opens. The King awaits your explanation.", 'success');
      launchConfetti();
      explain(...vals);
    }else{
      markInvalid(invalidIdx);
      toast("Not yet. " + errs.join(" "), 'error');
    }
  });

  $('#explainBtn').addEventListener('click', ()=>{
    const vals = getValues();
    if(vals.every(Number.isFinite)){
      explain(...vals);
      toast("Generated a clear proof for the King.", 'success');
    }else{
      toast("Enter numbers first or use Auto-fill to see a worked solution.", 'warn');
    }
  });

  $('#hintBtn').addEventListener('click', ()=>{
    const msg = hints[Math.min(hintIndex, hints.length-1)];
    hintIndex++;
    toast("Hint: " + msg, 'warn');
  });

  $('#fillBtn').addEventListener('click', ()=>{
    setValues([40,20,30,10]); // The unique solution
    toast("Numbers auto-filled. You can still hit Check or Explain.", 'success');
  });

  $('#resetBtn').addEventListener('click', ()=>{
    inputs.forEach(i=>{ i.value = ""; i.setAttribute('aria-invalid','false'); });
    $('#reasoningText').textContent = "";
    $('#reason').open = false;
    $('#status').style.display = 'none';
    hintIndex = 0;
    log(`[${new Date().toLocaleTimeString()}] Reset. A fresh hourglass starts.`);
    startTimer();
  });

  // Restrict inputs to digits only
  inputs.forEach(inp=>{
    inp.addEventListener('input', (e)=>{
      const cleaned = e.target.value.replace(/[^\d-]/g, '');
      if(cleaned !== e.target.value) e.target.value = cleaned;
    });
  });

  // Initialize
  startTimer();

  // Respect reduced motion
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    document.documentElement.style.setProperty('--duration', '0s');
  }

  // Log initial message
  log(`[${new Date().toLocaleTimeString()}] The King awaits. Enter the Four Magic Numbers.`);
</script>
</body>
</html>
